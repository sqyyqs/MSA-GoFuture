@startuml Container_Diagram_Full_Infrastructure
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(passenger, "Пассажир", "Заказывает поездки")
Person(driver, "Водитель", "Принимает заказы и получает выплаты")
Person(manager, "Корпоративный менеджер", "Управляет счетами")
Person(accountant, "Бухгалтер", "Контролирует выплаты")
Person(dev_engineer, "Разработчик", "Разрабатывает новые функции")
Person(sre_engineer, "SRE инженер", "Мониторит и поддерживает систему")

System_Boundary(go_future_system, "GoFuture Platform") {
    ' ### КЛИЕНТСКИЕ ПРИЛОЖЕНИЯ ###
    Container(web_passenger, "Пассажирское приложение", "iOS/Android/Huawei", "Интерфейс для пассажиров")
    Container(web_driver, "Водительское приложение", "iOS/Android/Huawei", "Интерфейс для водителей")
    Container(web_portal, "Корпоративный веб-портал", "Web Application", "Управление заказами")
    Container(admin_portal, "Админ-панель", "Web Application", "Управление выплатами")
    
    ' ### ОСНОВНОЙ МОНОЛИТ ###
    Container(app_monolith, "GoFuture Monolith", "Django Application", "Содержит всю бизнес-логику")


    Container(passenger_bff, "Passenger App Gateway", "Django Application", "Шлюз для приложения для пользователей")
    Container(driver_bff, "Driver App Gateway", "Django Application", "Шлюз для приложения для водителей")
    Container(portal_bff, "Corporate Web-Portal App Gateway", "Django Application", "Шлюз для приложения для корпоративного веб-портала")
    Container(admin_bff, "Admin Panel App Gateway", "Django Application", "Шлюз для приложения для админской панели")

    Container(booking_service, "Booking Service", "Django Application", "Сервис, отвечающий за управление заказами")
    Container(driver_service, "Driver Service", "Django Application", "Сервис, отвечающий за модуль управления аккаунтами водителей")
    Container(pricing_service, "Pricing Service", "Django Application", "Сервис, отвечающий за формирование цен")
    Container(payments_service, "Payments Service", "Django Application", "Сервис, отвечающий за провод платежей")
    Container(notification_service, "Notification Service", "Django Application", "Сервис, отвечающий за отправку обновлений")
    Container(geo_service, "GeoProcessing Service", "Django Application", "Сервис, отвечающий за работу с геоданными")

    ' ### БАЗЫ ДАННЫХ ###
    ContainerDb(booking_service_db, "BookingService БД", "PostgreSQL")
    ContainerDb(driver_service_db, "DriverService БД", "PostgreSQL")
    ContainerDb(pricing_service_db, "PricingService БД", "PostgreSQL")
    ContainerDb(payments_service_db, "PaymentsService БД", "PostgreSQL")
    ContainerDb(notification_service_db, "NotificationService БД", "PostgreSQL")
    ContainerDb(geo_service_db, "GeoService БД", "PostgreSQL + PostGIS")

    ContainerDb(db_cache, "In-memory кэш", "Redis", "Кэширование данных")
    ContainerDb(db_search, "Поисковый индекс", "Elasticsearch", "Геопоиск водителей")
    
    ' ### ОЧЕРЕДИ И ВОРКЕРЫ ###
    ContainerQueue(main_broker, "Брокер сообщений", "Kafka")
    Container(app_worker, "Воркеры фоновых задач", "Celery", "Обработка асинхронных задач")
    
    ' ### МОНИТОРИНГ И OBSERVABILITY ###
    Container(monitoring, "Prometheus", "Monitoring System", "Сбор метрик и мониторинг")
    Container(grafana, "Grafana", "Dashboard System", "Визуализация метрик и дашборды")
    Container(loki, "Loki", "Log Aggregation", "Сбор и анализ логов")
    Container(alert_manager, "Alertmanager", "Alert System", "Управление алертами")
    
    ' ### CI/CD ИНФРАСТРУКТУРА ###
    Container(jenkins, "Jenkins", "CI/CD Server", "Сборка и деплой монолита")
    Container(artifact_repo, "Artifact Repository", "Docker Registry", "Хранение образов приложения")
    Container(ci_worker, "CI/CD Workers", "VM/Containers", "Выполнение задач сборки и тестов")
    
    ' ### АНАЛИТИЧЕСКАЯ ИНФРАСТРУКТУРА ###
    Container(analytics_engine, "Analytics Engine", "Spark/Flink", "Обработка аналитических данных")
    Container(analytics_db, "Analytics DB", "ClickHouse", "Хранение аналитических данных")
    Container(datalens, "DataLens", "BI Tool", "Визуализация бизнес-метрик")
}

' ### ВНЕШНИЕ СИСТЕМЫ ###
System_Ext(yandex_pay, "Яндекс.Пэй", "Платежный шлюз")
System_Ext(yandex_maps, "Яндекс.Карты", "Картографический сервис")
System_Ext(fcm, "FCM", "Push-сервис Google")
System_Ext(apns, "APNs", "Push-сервис Apple")
System_Ext(huawei_push, "Huawei Push Kit", "Push-сервис Huawei")
System_Ext(bank_api, "API Банка", "Банковские выплаты")

' ### СВЯЗИ ПОЛЬЗОВАТЕЛЕЙ ###
Rel(passenger, web_passenger, "Использует")
Rel(driver, web_driver, "Использует")
Rel(manager, web_portal, "Использует")
Rel(accountant, admin_portal, "Использует")
Rel(dev_engineer, jenkins, "Запускает сборки")
Rel(sre_engineer, grafana, "Мониторит систему")
Rel(sre_engineer, alert_manager, "Настраивает алерты")

' ### микросервисы ###
Rel(portal_bff, booking_service, "HTTP/REST API")
Rel(portal_bff, geo_service, "HTTP/REST API")
Rel(portal_bff, pricing_service, "HTTP/REST API")
Rel(portal_bff, payments_service, "HTTP/REST API")
Rel(portal_bff, driver_service, "HTTP/REST API")

Rel(driver_bff, booking_service, "HTTP/REST API")
Rel(driver_bff, geo_service, "HTTP/REST API")
Rel(driver_bff, payments_service, "HTTP/REST API")
Rel(driver_bff, driver_service, "HTTP/REST API")

Rel(admin_bff, booking_service, "HTTP/REST API")
Rel(admin_bff, geo_service, "HTTP/REST API")
Rel(admin_bff, payments_service, "HTTP/REST API")
Rel(admin_bff, driver_service, "HTTP/REST API")
Rel(admin_bff, pricing_service, "HTTP/REST API")

Rel(passenger_bff, booking_service, "HTTP/REST API")
Rel(passenger_bff, geo_service, "HTTP/REST API")
Rel(passenger_bff, payments_service, "HTTP/REST API")
Rel(passenger_bff, pricing_service, "HTTP/REST API")

Rel(booking_service, booking_service_db, Хранит данные в )
Rel(driver_service, driver_service_db, Хранит данные в )
Rel(geo_service, geo_service_db, Хранит данные в )
Rel(payments_service, payments_service_db, Хранит данные в )
Rel(pricing_service, pricing_service_db, Хранит данные в )
Rel(notification_service, notification_service_db, Хранит данные в )


' ### БИЗНЕС-ЛОГИКА ###
Rel(web_passenger, passenger_bff, "HTTP/REST API")
Rel(web_driver, driver_bff, "HTTP/REST API")
Rel(web_portal, portal_bff, "HTTP/REST API")
Rel(admin_portal, admin_bff, "HTTP/REST API")

Rel(passenger_bff, db_cache, "Кэширование данных")
Rel(geo_service, db_search, "Геопоиск водителей")
Rel(booking_service, main_broker, "Отправка задач")

Rel(payments_service, yandex_pay, "Обработка платежей")
Rel(geo_service, yandex_maps, "Запросы геоданных")
Rel(payments_service, bank_api, "Инициирование выплат")

' ### ASYNC WORKERS ###
Rel(booking_service, main_broker, "Работает с ")
Rel(driver_service, main_broker, "Работает с ")
Rel(pricing_service, main_broker, "Работает с ")
Rel(geo_service, main_broker, "Работает с ")
Rel(payments_service, main_broker, "Работает с ")
Rel(notification_service, main_broker, "Работает с ")

Rel(app_worker, main_broker, "Получает задачи из")
Rel(app_worker, booking_service, Метрики )
Rel(app_worker, driver_service, Метрики )
Rel(app_worker, geo_service, Метрики )
Rel(app_worker, payments_service,Метрики )
Rel(app_worker, pricing_service, Метрики )
Rel(app_worker, notification_service, Метрики )
Rel(app_worker, main_broker, "Сохраняет результаты")
Rel(app_worker, fcm, "Отправляет уведомления", "REST API")
Rel(app_worker, apns, "Отправляет уведомления", "REST API")
Rel(app_worker, huawei_push, "Отправляет уведомления", "REST API")
Rel(app_worker, bank_api, "Выполняет выплаты", "REST API")

' ### МОНИТОРИНГ ###
Rel(app_worker, monitoring, "Отправляет метрики", "Prometheus Metrics")

Rel(booking_service, monitoring, Метрики )
Rel(driver_service, monitoring, Метрики )
Rel(geo_service, monitoring, Метрики )
Rel(payments_service, monitoring,Метрики )
Rel(pricing_service, monitoring, Метрики )
Rel(notification_service, monitoring, Метрики )

Rel(booking_service_db, monitoring, Метрики БД )
Rel(driver_service_db, monitoring, Метрики БД)
Rel(geo_service_db, monitoring, Метрики БД)
Rel(payments_service_db, monitoring,Метрики БД )
Rel(pricing_service_db, monitoring, Метрики БД)
Rel(notification_service_db, monitoring, Метрики БД)

Rel(main_broker, monitoring, "Метрики очередей", "Kafka Exporter")

Rel(monitoring, grafana, "Предоставляет данные", "PromQL")
Rel(monitoring, alert_manager, "Отправляет алерты", "Alert Rules")
Rel(alert_manager, sre_engineer, "Отправляет уведомления", "Email/Slack/Pager")

Rel(booking_service, loki, Логи )
Rel(driver_service, loki, Логи )
Rel(geo_service, loki, Логи )
Rel(payments_service, loki,Логи )
Rel(pricing_service, loki, Логи )
Rel(notification_service, loki, Логи )

Rel(app_worker, loki, "Отправляет логи", "Loki Logs")

' ### CI/CD ###
Rel(jenkins, ci_worker, "Запускает задачи", "SSH/API")
Rel(ci_worker, artifact_repo, "Пушит образы", "Docker Push")
Rel(jenkins, artifact_repo, "Деплоит образы", "Docker Pull")
Rel(ci_worker, admin_bff, "Запускает тесты", "Test Execution")

' ### АНАЛИТИКА ###
Rel(app_monolith, analytics_engine, "Отправляет события", "AMQP")
Rel(booking_service, analytics_engine, "Отправляет события", "AMQP")
Rel(analytics_engine, analytics_db, "Записывает данные", "ETL Process")
Rel(analytics_db,datalens, "Предоставляет данные", "SQL Queries")
Rel(datalens, manager, "Бизнес-отчеты", "Dashboards")
Rel(datalens, accountant, "Финансовые отчеты", "Dashboards")

@enduml